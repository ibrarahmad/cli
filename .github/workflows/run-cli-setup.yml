name: Deploy pgEdge Local Cluster

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-cluster:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 curl openssh-client openssh-server
          sudo systemctl start ssh

      - name: Create pgedge user
        run: |
          sudo useradd -m pgedge
          sudo mkdir -p /home/pgedge/.ssh
          sudo chmod 700 /home/pgedge/.ssh
          ssh-keygen -t rsa -b 4096 -f /home/pgedge/.ssh/id_rsa -N ""
          sudo cp /home/pgedge/.ssh/id_rsa.pub /home/pgedge/.ssh/authorized_keys
          sudo chmod 600 /home/pgedge/.ssh/authorized_keys
          sudo chown -R pgedge:pgedge /home/pgedge/.ssh
          echo "Host localhost
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null" | sudo tee -a /etc/ssh/ssh_config

      - name: Test SSH connection
        run: |
          sudo -u pgedge ssh -o "StrictHostKeyChecking no" localhost "echo SSH connection successful"

      - name: Install pgEdge Platform
        run: |
          sudo apt-get install -y python3 curl
          python3 -c "$(curl -fsSL https://pgedge-download.s3.amazonaws.com/REPO/install.py)"

      - name: Create pgEdge directory
        run: mkdir -p /home/runner/work/cli/cli/pgedge/cluster/demo

      - name: Add demo.json file
        run: |
          echo '{
            "name": "demo",
            "style": "aws",
            "log_level": "none",
            "create_date": "2024-05-08",
            "localhost": {
              "os_user": "pgedge",
              "ssh_key": ""
            },
            "database": {
              "databases": [
                {
                  "username": "lcusr",
                  "password": "lcpasswd",
                  "name": "lcdb"
                }
              ],
              "pg_version": "16",
              "auto_ddl": "off"
            },
            "node_groups": {
              "localhost": [
                {
                  "nodes": [
                    {
                      "name": "n1",
                      "is_active": true,
                      "ip_address": "127.0.0.1",
                      "port": 6432,
                      "path": "/home/runner/work/demo/n1"
                    }
                  ]
                },
                {
                  "nodes": [
                    {
                      "name": "n2",
                      "is_active": true,
                      "ip_address": "127.0.0.1",
                      "port": 6433,
                      "path": "/home/runner/work/demo/n2"
                    }
                  ]
                }
              ]
            }
          }' > /home/runner/work/cli/cli/pgedge/cluster/demo/demo.json

      - name: Initialize the Cluster
        run: |
          cd /home/runner/work/cli/cli/pgedge/
          ./pgedge cluster init demo
